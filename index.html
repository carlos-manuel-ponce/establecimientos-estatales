<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="LOGO NUEVO COLOR_122003.png" />
  <!-- Montserrat Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DGE - Establecimientos Estatales</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    :root {
        --azul-institucional: #1B2A41;
  --celeste: #56B4C6;
  --fondo-gradiente: linear-gradient(135deg, #e3f0ff 0%, #b3d8f8 50%, #5fa8e6 100%);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Montserrat', 'Inter', sans-serif;
      background: #fff !important;
      color: #111827;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', 'Inter', sans-serif;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    th, .etiqueta, .carpeta button, .carpeta h3 {
      font-family: 'Montserrat', 'Inter', sans-serif;
      font-weight: 600;
    }

    /* Si quieres que todo el texto sea semi-bold, descomenta la siguiente línea */
    /* body, p, td, input, button, span, label { font-family: 'Montserrat', 'Inter', sans-serif; font-weight: 600; } */

   header {
  width: 100%;
  background: #1B2A41 !important;
  color: #fff !important;
  box-shadow: 0 8px 24px 0 rgba(27,42,65,0.10), 0 2px 8px 0 rgba(86,180,198,0.07);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1500;
  backdrop-filter: blur(4px);
}

    .header-content {
      max-width: 1300px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header img { height: 40px; }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 500;
      text-align: right;
    }

    .buscador {
      background: transparent;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: none;
      z-index: 1;
      color: #fff;
      margin-top: 1.25rem;
      margin-bottom: 1.25rem;
      padding: 1.5rem 0 1.2rem 0;
      border-radius: 0;
      position: relative;
    }

    .buscador input {
      width: 75%;
      max-width: 600px;
      padding: 0.8rem 1.2rem;
      border-radius: 50px;
      border: none;
      font-size: 1rem;
      transition: 0.3s ease;
      background: var(--azul-institucional);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .buscador input:focus {
  outline: 2px solid #56B4C6;
  box-shadow: 0 0 10px #56B4C6cc, 0 2px 8px rgba(0,0,0,0.08);
  border: none;
}

    .container {
  width: 100vw;
  max-width: 100vw;
  margin: 0;
  box-sizing: border-box;
  padding: 0;
  overflow-x: hidden;
    }

    .carpetas-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
  gap: 2rem;
  padding: 2.25rem 1rem 3rem 1rem;
  width: 100%;
  box-sizing: border-box;
    }
    /* Forzar 3x3 en pantallas grandes */
    @media (min-width: 901px) {
      .carpetas-container {
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: 1fr;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      /* Mostrar sólo las primeras 9 tarjetas para un 3x3 fijo */
      .carpetas-container .carpeta:nth-child(n+10) { display: none; }
      .carpeta { min-height: 200px; }
    }
    @media (max-width: 1200px) {
      .carpetas-container {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.2rem;
        padding: 2rem 0.5rem 2.5rem 0.5rem;
      }
    }
    @media (max-width: 900px) {
      .carpetas-container {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1.5rem 0.2rem 2rem 0.2rem;
      }
    }
    @media (max-width: 600px) {
      .carpetas-container {
        grid-template-columns: 1fr;
        gap: 0.7rem;
        padding: 1rem 0.1rem 1.5rem 0.1rem;
      }
    }

    .carpeta {
      background: var(--azul-institucional) !important;
      color: #fff !important;
      border-radius: 20px;
      border: 2.5px solid #1B2A41;
      padding: 2rem 1.2rem;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      position: relative;
      line-height: 1.6;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      transform: translateY(40px);
      min-height: 220px;
      height: 100%;
      min-width: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
      .carpeta {
        padding: 1.1rem 0.7rem;
        min-height: 160px;
      }
    }

    .carpeta.enter {
      animation: slideUp 0.7s ease forwards;
      animation-delay: var(--delay, 0ms);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .carpeta:hover {
      transform: translate(16px, -6px) scale(1.03);
      box-shadow: 0 16px 32px 0 rgba(27,42,65,0.25), 0 0 0 4px #56B4C6aa;
      filter: brightness(1.08) saturate(1.2);
      transition: box-shadow 0.25s, filter 0.25s, transform 0.25s;
    }

    .etiqueta {
      position: absolute;
      top: -16px;
      left: 24px;
      background: #5EC5D1;
      color: #fff;
      font-weight: 600;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }

  .carpeta h3 { color: var(--celeste); font-weight: 700; font-size: 1.3rem; margin-top: 1rem; }
  .carpeta p { color: #e5e7eb; font-size: 0.95rem; margin-top: 0.5rem; }

    .carpeta button {
      margin-top: 1rem;
      background: #fff;
      color: #3B65A3;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.4rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .carpeta button:hover { background: #3a8fa1; }

    .listado {
      display: none;
      width: 100vw;
      max-width: 100vw;
      margin: 0;
      background: #fff !important;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 1.5rem 0 2rem 0;
      overflow-x: auto;
      box-sizing: border-box;
      min-width: 0;
    }
    @media (max-width: 600px) {
      .listado {
        padding: 0.7rem 0.1rem 1rem 0.1rem;
        border-radius: 10px;
      }
    }

  .listado table {
  width: 100vw;
  max-width: 100vw;
  margin: 0;
  box-sizing: border-box;
  padding: 0;
  overflow-x: hidden;
  background: transparent !important;
      border-radius: 18px;
      overflow: visible;
      box-shadow: 0 2px 10px rgba(86,180,198,0.07);
      background: #fff;
      table-layout: auto;
      word-break: break-word;
      font-size: 1em;
    }
    @media (max-width: 900px) {
      .listado table {
        min-width: 400px;
        max-width: 100vw;
      }
    }
    @media (max-width: 600px) {
      .listado table {
        min-width: 320px;
        max-width: 100vw;
      }
    }
    @media (max-width: 600px) {
      .listado table {
        font-size: 0.93em;
        min-width: 220px;
      }
    }
    .listado th, .listado td {
      font-size: 12px;
      white-space: normal;
      text-overflow: initial;
      overflow: visible;
      max-width: none;
      vertical-align: middle;
      border: 1px solid #e5e7eb;
      word-break: break-word;
    }
    .listado tbody tr:nth-child(even) {
      background: #f3f4f6;
    }
    .listado tbody tr:nth-child(odd) {
      background: #e5e7eb;
    }
    .listado thead tr {
      background: var(--azul-institucional);
    }
    .listado td {
      font-size: 0.98em;
      padding-top: 0.7em;
      padding-bottom: 0.7em;
    }
  /* Se eliminan restricciones de ancho en media queries para que la tabla nunca se achique ni recorte campos */

    th, td {
      padding: 0.7rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      word-break: break-word;
    }
    @media (max-width: 600px) {
      th, td {
        padding: 0.5rem 0.2rem;
        font-size: 0.93em;
      }
    }

    th { background: var(--azul-institucional); color: white; }

  /* Eliminado: ya cubierto por los nuevos media queries */
  </style>
</head>
<body>
  <!-- Modal Login -->
<div id="modal-login" class="modal-login" style="display:flex;">
  <div class="modal-login-content">
    <img src="LOGO NUEVO COLOR_122003.png" alt="Logo San Luis - Ministerio de Educación" style="height:38px;max-width:400px;width:auto;display:block;margin:0 auto 1.2em auto;">
    <h2 style="color:#1B2A41;font-weight:700;margin-bottom:0.7em;">Acceso al Sistema</h2>
  <div class="login-group" style="width:100%;max-width:320px;text-align:center;">
  <label for="pin-login" style="display:block;font-weight:400;color:#1B2A41;margin-bottom:0.9rem;">Ingrese su PIN de 4 dígitos:</label>
  <!-- helper text intentionally removed per request -->
  <input type="password" id="pin-login" placeholder="****" style="width:100%;padding:0.6em 0.6em;border-radius:20px;border:1.5px solid #b2ebf2;font-size:1.08em;background:#e0f7fa;color:#1B2A41;margin-bottom:0.9rem;text-align:center;font-family: 'Courier New', monospace;">
  </div>
  <button id="btn-login" style="background:#56B4C6;color:white;border:none;padding:0.7em 2.2em;border-radius:10px;font-size:1.08em;font-weight:600;cursor:pointer;">Acceder</button>
  <div id="login-error" style="color:#dc2626;font-weight:600;margin-top:1em;display:none;"></div>
  <div style="margin-top:1.1rem;font-size:0.86em;color:#405060;text-align:center;opacity:0.9;">© 2025 Ministerio de Educación. Gobierno de la Provincia de San Luis</div>
  </div>
</div>

<style>
.modal-login {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #1B2A41; /* Azul institucional */
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s;
}
.modal-login-content {
  background: rgba(255,255,255,0.92);
  border-radius: 18px;
  padding: 2.2rem 2.2rem 2rem 2.2rem;
  min-width: 320px;
  max-width: 370px;
  width: 96vw;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  position: relative;
  font-size: 1.08em;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  animation: modalIn 0.25s cubic-bezier(.4,2,.6,1) forwards;
}
@media (max-width: 600px) {
  .modal-login-content {
    min-width: 90vw;
    max-width: 99vw;
    padding: 1.2rem 0.7rem 1.2rem 0.7rem;
  }
}
</style>

<style>
  /* Center masked PIN characters and placeholder */
  #pin-login { text-align: center; letter-spacing: 0.9em; -webkit-text-security: disc; font-variant-numeric: tabular-nums; }
  /* Ensure placeholder asterisks are centered and spaced the same */
  #pin-login::placeholder { text-align: center; letter-spacing: 0.9em; opacity: 0.6; }
  #pin-login::-webkit-input-placeholder { text-align:center; letter-spacing:0.9em; }
  #pin-login::-moz-placeholder { text-align:center; letter-spacing:0.9em; }
  #pin-login:-ms-input-placeholder { text-align:center; letter-spacing:0.9em; }
  #pin-login:-moz-placeholder { text-align:center; letter-spacing:0.9em; }
</style>
</style>

<script>
// Login y roles por PIN
let rolUsuario = null;
document.addEventListener('DOMContentLoaded', () => {
  const modalLogin = document.getElementById('modal-login');
  const btnLogin = document.getElementById('btn-login');
  const pinInput = document.getElementById('pin-login');
  const errorDiv = document.getElementById('login-error');
  function mostrarLogin() {
    document.getElementById('modal-login').style.display = 'flex';
    document.getElementById('contenido-app').style.display = 'none';
    pinInput.value = '';
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
    document.body.style.overflow = 'hidden';
  }
  function ocultarLogin() {
    document.getElementById('modal-login').style.display = 'none';
    document.getElementById('contenido-app').style.display = '';
    document.body.style.overflow = '';
  }
  btnLogin.onclick = function() {
    const pin = pinInput.value.trim();
    if (pin === '1232') {
      rolUsuario = 'admin';
      ocultarLogin();
      mostrarElementosPorRol();
    } else if (pin === '3519') {
      rolUsuario = 'lectura';
      ocultarLogin();
      mostrarElementosPorRol();
    } else {
      errorDiv.textContent = 'PIN incorrecto. Intente nuevamente';
      errorDiv.style.display = 'block';
    }
  };
  pinInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') btnLogin.click();
  });
  mostrarLogin();
});
// Ocultar botones de edición si rol es solo lectura
function mostrarElementosPorRol() {
  setTimeout(() => {
    if (rolUsuario === 'lectura') {
  // Ocultar si existen en DOM (por si el modal fue creado dinámicamente después del login)
  const editar = document.getElementById('editar-modal');
  const guardar = document.getElementById('guardar-modal');
  if (editar) editar.style.display = 'none';
  if (guardar) guardar.style.display = 'none';
    }
  }, 300);
}
</script>
  <style>
    /* Ajustes específicos para iPhone 11 y móviles pequeños (ancho 414px o menos) */
    @media (max-width: 430px) {
      .listado > div {
        padding: 0.1em 0.1em 0.1em 0.1em !important;
        border-radius: 7px !important;
      }
      #listado-titulo {
        font-size: 0.98em !important;
        margin-bottom: 0.3em;
      }
      #filtros-listado label,
      #filtros-listado select {
        font-size: 0.89em !important;
      }
      #buscador-listado {
        max-width: 100% !important;
        min-width: 80px;
        font-size: 0.95em !important;
        margin: 0.3em 0 0.3em 0 !important;
      }
      #cerrar-listado {
        margin: 0.3em 0 0.3em 0 !important;
        width: 100%;
        font-size: 0.93em !important;
      }
      .listado > div > div {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.5em !important;
      }
      #tabla-establecimientos {
        font-size: 0.78em !important;
      }
      #tabla-establecimientos th, #tabla-establecimientos td {
        padding: 0.18em 0.08em !important;
        font-size: 0.78em !important;
      }
      #contadores-buscador-panel {
        min-width: 90px !important;
        max-width: 120px !important;
        padding: 0.4em 0.4em 0.4em 0.3em !important;
        font-size: 0.85em !important;
      }
      #buscador-bar {
        width: 99vw !important;
        max-width: 99vw !important;
      }
      #buscador {
        font-size: 0.93em !important;
        padding: 0.6em 0.6em 0.6em 2em !important;
      }
      footer {
        font-size: 0.93em !important;
        padding: 0.7em 0 !important;
      }
    }
  </style>
  <style>
    /* Responsive para listado y elementos principales */
    @media (max-width: 900px) {
      .listado > div {
        padding: 0.7em 0.2em 0.7em 0.2em !important;
        border-radius: 10px !important;
      }
      #listado-titulo {
        font-size: 1.1em !important;
      }
      #filtros-listado label,
      #filtros-listado select {
        font-size: 0.98em !important;
      }
      #buscador-listado {
        max-width: 100% !important;
        min-width: 120px;
        margin: 0.5em 0 0.5em 0 !important;
      }
      #cerrar-listado {
        margin: 0.5em 0 0.5em 0 !important;
        width: 100%;
      }
      .listado > div > div {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.7em !important;
      }
      #tabla-establecimientos {
        font-size: 0.93em !important;
      }
    }
    @media (max-width: 600px) {
      .listado > div {
        padding: 0.3em 0.1em 0.3em 0.1em !important;
      }
      #tabla-establecimientos th, #tabla-establecimientos td {
        padding: 0.4em 0.2em !important;
        font-size: 0.89em !important;
      }
      #tabla-establecimientos {
        font-size: 0.85em !important;
      }
      #listado-titulo {
        font-size: 1em !important;
      }
      #filtros-listado label,
      #filtros-listado select {
        font-size: 0.93em !important;
      }
      #cerrar-listado {
        font-size: 0.98em !important;
      }
    }
    @media (max-width: 480px) {
      #tabla-establecimientos th, #tabla-establecimientos td {
        font-size: 0.78em !important;
        padding: 0.25em 0.1em !important;
      }
      #listado-titulo {
        font-size: 0.93em !important;
      }
      #cerrar-listado {
        font-size: 0.93em !important;
      }
    }
    /* Ajustes para el panel de contadores en móvil */
    @media (max-width: 600px) {
      #contadores-buscador-panel {
        min-width: 120px !important;
        max-width: 180px !important;
        padding: 0.7em 0.7em 0.7em 0.5em !important;
        font-size: 0.93em !important;
      }
    }
    /* Ajustes para el buscador principal */
    @media (max-width: 600px) {
      #buscador-bar {
        width: 98vw !important;
        max-width: 99vw !important;
      }
      #buscador {
        font-size: 0.98em !important;
        padding: 0.7em 0.7em 0.7em 2.2em !important;
      }
    }
  </style>
<div id="modal-detalle" class="modal-detalle" style="display:none;">
    <div class="modal-contenido">
      <div class="modal-header" style="flex-direction:column;align-items:center;gap:0.5em;position:relative;">
        <img src="LOGO NUEVO COLOR_122003.png" alt="Logo San Luis - Ministerio de Educación" style="height:30px;max-width:400px;width:auto;display:block;margin:0 auto;">
      </div>
      <button id="cerrar-modal" style="background:#dc2626;color:white;border:none;padding:0.4rem 1rem;border-radius:6px;cursor:pointer;font-size:1.1em;position:absolute;top:18px;right:18px;z-index:1100;">×</button>
      <div id="modal-body"></div>
  <!-- Botones del modal generados dinámicamente por JS -->
    </div>
  </div>
  <style>
    .modal-detalle {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(27,42,65,0.75);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-contenido {
      background: #e0f7fa;
      border-radius: 18px;
      padding: 1.2rem 1.2rem 1rem 1.2rem;
      min-width: 340px;
      max-width: 830px;
      width: 96vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      position: relative;
      font-size: 1.01em;
      animation: modalIn 0.25s cubic-bezier(.4,2,.6,1) forwards;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: translateY(60px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.2em;
    }
    .modal-contenido label {
      font-weight: 600;
      color: #1B2A41;
      margin-top: 0.7em;
      margin-bottom: 0.7em;
      display: block;
    }
    .modal-body-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
  gap: 1em 0;
      width: 100%;
      margin-bottom: 1em;
    }
    @media (max-width: 900px) {
      .modal-body-grid {
        grid-template-columns: 1fr;
      }
    }
    .modal-contenido input, .modal-contenido select, .modal-contenido textarea {
      width: 100%;
      padding: 0.5em 0.8em;
      border-radius: 8px;
      border: 1px solid #b2ebf2;
      margin-top: 0.2em;
      margin-bottom: 0.7em;
      font-size: 1em;
      background: #e0f7fa;
    }
    .modal-contenido input[readonly], .modal-contenido textarea[readonly] {
      background: #b2ebf2;
      color: #555;
    }
  </style>
  <script>
    let modalEstablecimiento = null;
    function abrirModalDetalle(item) {
      modalEstablecimiento = {...item};
      const modal = document.getElementById('modal-detalle');
      const body = document.getElementById('modal-body');
      // Orden y columna personalizada
      const camposOrdenados = [
        {nombre:'categoria',col:'izq'}, {nombre:'region',col:'der'},
        {nombre:'denominacion',col:'izq'}, {nombre:'localidad',col:'der'},
        {nombre:'nro',col:'izq'}, {nombre:'departamento',col:'der'},
        {nombre:'nombre',col:'izq'}, {nombre:'ambito',col:'der'},
        {nombre:'modalidad',col:'izq'}, {nombre:'niveles',col:'der'}
      ];
      let htmlIzq = '', htmlDer = '';
      camposOrdenados.forEach(obj => {
        const campo = obj.nombre;
        if (typeof item[campo] === 'undefined') return;
        const label = `<label style='width:100%;'>${campo.charAt(0).toUpperCase()+campo.slice(1)}<input type='text' name='${campo}' value="${item[campo]||''}" readonly></label>`;
        if(obj.col==='izq') htmlIzq += label;
        else htmlDer += label;
      });
      body.innerHTML = `<div style='display:grid;grid-template-columns:1fr 1fr;gap:1.1em 2em;width:100%;margin-bottom:1em;'>
        <div>${htmlIzq}</div>
        <div>${htmlDer}</div>
      </div>
      <div style='display:flex;justify-content:center;gap:0.6rem;margin-top:1.2em;'>
        <button id='ver-matricula' style='background:var(--celeste);color:#fff;border:none;padding:0.6rem 1.6rem;border-radius:8px;cursor:pointer;font-weight:600;'>Ver Matricula</button>
        <button id='ver-pof' style='background:var(--celeste);color:#fff;border:none;padding:0.6rem 1.6rem;border-radius:8px;cursor:pointer;font-weight:600;'>Ver POF</button>
        <button id='editar-modal' style='background:#1B2A41;color:white;border:none;padding:0.7rem 2.2rem;border-radius:8px;cursor:pointer;font-weight:600;margin-left:0.4rem;'>Editar</button>
        <button id='guardar-modal' style='background:#56B4C6;color:white;border:none;padding:0.7rem 2.2rem;border-radius:8px;cursor:pointer;font-weight:600;display:none;margin-left:0.7em;'>Guardar</button>
      </div>`;
      modal.style.display = 'flex';
      // Ocultar botón editar si el rol es lectura
      if (typeof rolUsuario !== 'undefined' && rolUsuario === 'lectura') {
        document.getElementById('editar-modal').style.display = 'none';
        document.getElementById('guardar-modal').style.display = 'none';
      } else {
        document.getElementById('editar-modal').style.display = '';
        document.getElementById('guardar-modal').style.display = 'none';
      }
    }
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('cerrar-modal').onclick = ()=>{
        document.getElementById('modal-detalle').style.display = 'none';
      };
      // Delegar eventos para los botones del modal (ya que se regeneran)
      document.getElementById('modal-body').addEventListener('click', function(e) {
        if (e.target && e.target.id === 'editar-modal') {
          document.querySelectorAll('#modal-body input').forEach(inp=>inp.removeAttribute('readonly'));
          document.getElementById('editar-modal').style.display = 'none';
          document.getElementById('guardar-modal').style.display = '';
        }
          // Ver Matricula
          if (e.target && e.target.id === 'ver-matricula') {
            const url = modalEstablecimiento?.url_matricula || modalEstablecimiento?.matricula_url || '';
            if (url) window.open(url, '_blank');
            else alert('No hay URL de matrícula disponible para este establecimiento.');
          }
          // Ver POF
          if (e.target && e.target.id === 'ver-pof') {
            const url = modalEstablecimiento?.url_pof || modalEstablecimiento?.pof_url || '';
            if (url) window.open(url, '_blank');
            else alert('No hay URL de POF disponible para este establecimiento.');
          }
        if (e.target && e.target.id === 'guardar-modal') {
          (async ()=>{
            const modal = document.getElementById('modal-detalle');
            const body = document.getElementById('modal-body');
            let datos = {};
            body.querySelectorAll('input').forEach(inp=>{
              datos[inp.name]=inp.value;
            });
            if (!modalEstablecimiento.id) { alert('No se puede editar: falta ID'); return; }
            const { error } = await supabaseClient
              .from('establecimientos')
              .update(datos)
              .eq('id', modalEstablecimiento.id);
            if (error) {
              alert('Error al guardar: '+error.message);
            } else {
              alert('Guardado correctamente');
              document.getElementById('modal-detalle').style.display = 'none';
              filtrarYMostrar();
            }
          })();
        }
      });
    });
  </script>
  <div id="contenido-app" class="content-padding-fix">
  <header>
    <div class="header-content">
      <img src="LOGO - MINISTERIO_032459.png" alt="Logo San Luis - Ministerio de Educación" />
      <h1><b>Dirección Gestión Educativa</b><br><span style="font-size:1rem; font-weight:300;"></span></h1>
    </div>
  </header>
  <div id="subtitulo" style="text-align:center;font-size:1.18em;font-weight:600;color:#1B2A41;margin-top:1.5em;margin-bottom:0.35em;max-width:900px;margin-left:auto;margin-right:auto;">
    Consulta los Establecimientos Educativos Estatales de la Provincia de San Luis
  </div>
  <div id="contadores-buscador-panel" style="position:fixed;left:0;top:120px;z-index:100;box-shadow:0 4px 18px 0 rgba(27,42,65,0.10), 0 2px 8px 0 rgba(86,180,198,0.08);background:var(--celeste);border-radius:0 18px 18px 0;padding:1.1em 1.7em 1.1em 1.2em;display:flex;flex-direction:column;gap:0.5em;align-items:flex-start;min-width:180px;max-width:260px;transition:opacity 0.3s;">
  <script>
    // Ocultar el panel de contadores al hacer scroll
    window.addEventListener('scroll', function() {
      const panel = document.getElementById('contadores-buscador-panel');
      if (window.scrollY > 0) {
        panel.style.opacity = '0';
        panel.style.pointerEvents = 'none';
      } else {
        panel.style.opacity = '1';
        panel.style.pointerEvents = 'auto';
      }
    });
  </script>
    <div style="font-size:13px;color:var(--azul-institucional);font-weight:900;">Establecimientos: <span id="contador-total" style="color:#fff;font-size:13px;font-weight:900;">0</span></div>
    <div style="font-size:12px;color:var(--azul-institucional);font-weight:700;">Carpetas: <span id="contador-carpetas" style="color:#fff;font-size:12px;font-weight:700;">0</span></div>
  </div>
  <div class="buscador" id="buscador-bar" style="margin-top:0;margin-bottom:0.1em;display:flex;justify-content:center;">
    <div style="position:relative;width:75%;max-width:600px;display:flex;align-items:center;">
      <span style="position:absolute;left:1.1rem;top:50%;transform:translateY(-50%);width:1.25em;height:1.25em;pointer-events:none;color:#56B4C6;opacity:0.85;font-size:1.25em;display:flex;align-items:center;justify-content:center;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </span>
      <input type="text" id="buscador" placeholder="Busqueda por palabra clave..." onkeyup="buscarElemento()" style="width:100%;padding:0.8rem 1.2rem 0.8rem 2.7rem;border-radius:50px;border:none;font-size:1rem;transition:box-shadow 0.3s,outline 0.3s,border 0.3s;background:var(--azul-institucional);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    </div>
    <div id="buscador-resultados" style="width:75%;max-width:600px;left:0;right:0;margin:0 auto;position:absolute;z-index:10;top:100%;"></div>
  </div>

  <div class="container" style="margin-top:2.2em;">
  <!-- Añadir padding-top equivalente a la altura del header para evitar solapamiento -->
  <style> .content-padding-fix { padding-top: 78px; } @media (max-width:600px){ .content-padding-fix{ padding-top: 92px; } } </style>
  <div id="inicio" class="carpetas-container">
  <div class="carpeta" data-denominacion="CENTRO EDUCATIVO"><h3>Centros Educativos</h3><p>Listado de Centros Educativos.</p><button onclick="abrirListado('CENTRO EDUCATIVO')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="ESCUELA"><h3>Escuelas</h3><p>Listado de Escuelas Provinciales.</p><button onclick="abrirListado('ESCUELA')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="COLEGIO"><h3>Colegios</h3><p>Listado de Colegios Provinciales.</p><button onclick="abrirListado('COLEGIO')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="ESCUELA DE NIVEL INICIAL"><h3>Escuelas de Nivel Inicial</h3><p>Listado de Escuelas de Nivel Inicial.</p><button onclick="abrirListado('ESCUELA DE NIVEL INICIAL')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="ESCUELA TÉCNICA"><h3>Escuelas Técnicas</h3><p>Listado de Escuelas Técnicas.</p><button onclick="abrirListado('ESCUELA TÉCNICA')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="ADULTOS"><h3>Jovenes/Adultos</h3><p>Incluye: Comercio, Centros Secundarios y Colegios/Escuelas para Adultos.</p><button onclick="abrirListado('ADULTOS')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <!-- Las siguientes categorías van al final -->
  <div class="carpeta" data-denominacion="ESCUELA DE EDUCACIÓN ESPECIAL"><h3>Escuelas de Educación Especial</h3><p>Listado de Escuelas de Educación Especial.</p><button onclick="abrirListado('ESCUELA DE EDUCACIÓN ESPECIAL')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <!-- Agrupadas dentro de 'ADULTOS' -->
  <div class="carpeta" data-denominacion="ESCUELA DE JORNADA COMPLETA"><h3>Escuelas de Jornada Completa</h3><p>Listado de Escuelas de Jornada Completa.</p><button onclick="abrirListado('ESCUELA DE JORNADA COMPLETA')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <div class="carpeta" data-denominacion="ESCUELA SECUNDARIA DE ARTE"><h3>Escuelas Secundarias de Arte</h3><p>Listado de Escuelas Secundarias de Arte.</p><button onclick="abrirListado('ESCUELA SECUNDARIA DE ARTE')">Abrir Listado</button><span class="total-carpeta" style="display:block;margin-top:0.7em;font-size:1.08em;color:#56B4C6;font-weight:600;"></span></div>
  <script>
    // Mostrar totales en cada carpeta
    document.addEventListener('DOMContentLoaded', async () => {
      const denominaciones = [
        'CENTRO EDUCATIVO',
        'ESCUELA',
        'COLEGIO',
        'ESCUELA DE NIVEL INICIAL',
        'ESCUELA DE EDUCACIÓN ESPECIAL',
        'ESCUELA TÉCNICA',
        'ESCUELA DE JORNADA COMPLETA',
        'ADULTOS',
        'ESCUELA SECUNDARIA DE ARTE'
      ];
      const { data, error } = await supabaseClient
        .from('establecimientos')
        .select('denominacion');
      if (!error && data) {
        denominaciones.forEach(denom => {
          let total = 0;
          if (denom === 'ADULTOS') {
            // ADULTOS agrupa varias denominaciones
            total = data.filter(e => [
              'COLEGIO PARA ADULTOS',
              'ESCUELA PARA ADULTOS',
              'ESCUELA DE COMERCIO',
              'CENTRO EDUCATIVO NIVEL SECUNDARIO'
            ].includes(e.denominacion)).length;
          } else {
            total = data.filter(e => e.denominacion === denom).length;
          }
          const card = document.querySelector(`.carpeta[data-denominacion="${denom}"] .total-carpeta`);
          if (card) card.textContent = `Total: ${total}`;
        });
      }
    });
  </script>
    </div>

  <section id="listado" class="listado" style="box-shadow:none;border-radius:0;margin-top:0;padding:0 0 0 0;background:#1B2A41;">
  <div style="width:98%;max-width:1400px;margin:1.5em auto 0 auto;padding:1.1em 1.2em 1.1em 1.2em;background:#fff;border-radius:16px;box-shadow:0 2px 10px #56B4C633;display:flex;flex-direction:column;align-items:stretch;gap:1em;margin-bottom:0.7em;border:1.5px solid #b2ebf2;">
    <div style="display:flex;flex-direction:row;align-items:center;justify-content:space-between;width:100%;gap:1em;">
    <div id="listado-titulo" style="font-size:1.35em;font-weight:700;color:#1B2A41;white-space:nowrap;margin-right:1.2em;"></div>
  <span style="font-weight:600;color:#1B2A41;margin-right:0.08em;">Buscador:</span>
  <input id="buscador-listado" type="text" placeholder="Buscar en el listado..." style="flex:1 1 220px;max-width:260px;padding:0.3em 0.7em;border-radius:6px;border:1px solid #b2ebf2;font-size:1em;background:#e0f7fa;color:#1B2A41;margin-right:0.18em;margin-left:0.01em;" onkeyup="filtrarYMostrar()">
  <span style="font-weight:600;color:#1B2A41;margin-right:0.08em;margin-left:0.01em;">Total:</span>
  <span id="total-listado-label" style="background:#e0f7fa;border-radius:6px;padding:0.3em 0.7em;border:1px solid #b2ebf2;font-size:1em;font-weight:600;color:#1B2A41;min-width:38px;display:inline-block;text-align:center;margin-left:0.01em;"> <span id="total-listado">0</span></span>
      <div id="filtros-listado" style="display:flex;gap:1em;align-items:center;">
        <label style="font-weight:600;color:#1B2A41;">Categoría:
          <select id="filtro-categoria-listado" style="margin-left:0.5em;padding:0.3em 0.7em;border-radius:6px;border:1px solid #b2ebf2;font-size:1em;background:#e0f7fa;color:#1B2A41;">
            <option value="">Todas</option>
          </select>
        </label>
        <label style="font-weight:600;color:#1B2A41;">Región:
          <select id="filtro-region-listado" style="margin-left:0.5em;padding:0.3em 0.7em;border-radius:6px;border:1px solid #b2ebf2;font-size:1em;background:#e0f7fa;color:#1B2A41;">
            <option value="">Todas</option>
          </select>
        </label>
      </div>
      <button id="cerrar-listado" style="background:#dc2626;color:white;border:none;padding:0.5em 1.2em;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;margin-left:1em;" onclick="mostrarVistaPrincipal()">Cerrar</button>
    </div>
  <div id="listado-tabla" style="padding:0;display:flex;justify-content:center;flex-direction:column;align-items:center;margin-top:0.2em;">
  <!-- <div id="resumen-listado"></div> -->
  <table id="tabla-establecimientos" style="width:98%;max-width:1400px;border-radius:22px;overflow:hidden;box-shadow:0 6px 24px rgba(27,42,65,0.18);background:var(--azul-institucional);margin:0 auto;border:1.2px solid #b2ebf2;">
          <thead style="position:sticky;top:0;z-index:2;background:var(--azul-institucional);">
            <tr>
               <th style="background:var(--azul-institucional);color:#fff;font-size:1.13em;padding:1.2em 0.7em;border:none;text-align:center;">Categoría</th>
               <th style="background:var(--azul-institucional);color:#fff;font-size:1.13em;padding:1.2em 0.7em;border:none;text-align:center;">Región</th>
               <th style="background:var(--azul-institucional);color:#fff;font-size:1.13em;padding:1.2em 0.7em;border:none;text-align:center;">Denominación</th>
               <th style="background:var(--azul-institucional);color:#fff;font-size:1.13em;padding:1.2em 0.7em;border:none;text-align:center;">N°</th>
               <th style="background:var(--azul-institucional);color:#fff;font-size:1.13em;padding:1.2em 0.7em;border:none;text-align:center;">Nombre</th>
            </tr>
          </thead>
          <tbody id="tabla-body" style="background:var(--azul-institucional);">
            <tr><td colspan='5' style='text-align:center;color:#e5e7eb;'>Seleccione una carpeta para ver los establecimientos.</td></tr>
          </tbody>
        </table>
        <div style="width:98%;max-width:1400px;display:flex;justify-content:center;gap:0.6rem;margin-top:0.8rem;">
                <style>
                  .export-btn{display:inline-flex;gap:0.6rem;align-items:center;padding:0.7em 1.1em;border-radius:8px;border:none;cursor:pointer;font-weight:700;color:#fff;font-size:1.05rem}
                  .export-btn svg{width:18px;height:18px}
                  #btn-export-pdf{background:#1B2A41}
                  #btn-export-xlsx{background:#56B4C6}
                  .export-btn[disabled]{opacity:0.5;cursor:not-allowed}
                </style>
                <button id="btn-export-pdf" class="export-btn" onclick="exportListadoPDF()" title="Generar PDF">
                  Generar PDF
                </button>
                <button id="btn-export-xlsx" class="export-btn" onclick="exportListadoExcel()" title="Generar EXCEL">
                  Generar EXCEL
                </button>
              </div>
      </div>
    </section>
  </div>

  <script>
    const supabaseUrl = 'https://csbcfhwdpstnofvsfqwh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYmNmaHdkcHN0bm9mdnNmcXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjkzODcsImV4cCI6MjA3MTcwNTM4N30.lX166U64tFeqKd6snFduL-oXWD_LXwzPMyQYVF3g8ek';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let datosActuales = [];
  let tipoActual = '';

  // Cargar y mostrar contadores al iniciar
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const { data, error } = await supabaseClient
        .from('establecimientos')
        .select('id, denominacion');
      if (!error && data) {
        // Total establecimientos
        document.getElementById('contador-total').textContent = data.length;
        // Total carpetas (preferir contar las tarjetas definidas en el DOM para reflejar la UI)
        const tarjetas = document.querySelectorAll('.carpeta');
        if (tarjetas && tarjetas.length > 0) {
          document.getElementById('contador-carpetas').textContent = tarjetas.length;
        } else {
          const totalCarpetas = new Set(data.map(e => (e.denominacion||'').toUpperCase())).size;
          document.getElementById('contador-carpetas').textContent = totalCarpetas;
        }
      }
    } catch (e) {
      // No mostrar error visual
    }
  });

  async function abrirListado(tipo) {
  // Ocultar el inicio y elementos principales, mostrar solo el listado
  const inicio = document.getElementById('inicio');
  if (inicio) inicio.style.display = 'none';
  // Ocultar subtítulo
  const subtitulo = document.getElementById('subtitulo');
  if (subtitulo) subtitulo.style.display = 'none';
  // Ocultar contadores
  const contadores = document.getElementById('contadores-buscador-panel');
  if (contadores) contadores.style.display = 'none';
  // Ocultar buscador
  const buscadorBar = document.getElementById('buscador-bar');
  if (buscadorBar) buscadorBar.style.display = 'none';
  // Reiniciar el buscador al abrir un listado
  const buscador = document.getElementById('buscador');
  if (buscador) buscador.value = '';
  const listado = document.getElementById('listado');
  if (listado) listado.style.display = 'block';
  tipoActual = tipo;

    // Mostrar el título de la carpeta
    // Mostrar el título de la carpeta en plural
    let titulo = tipo.trim();
    // Si termina en vocal, agrega 's', si termina en consonante agrega 'es', si ya es plural no cambia
    if (!/s$/i.test(titulo)) {
      if (/[aeiouáéíóú]$/i.test(titulo)) {
        titulo += 's';
      } else {
        titulo += 'es';
      }
    }
    document.getElementById('listado-titulo').textContent = titulo.charAt(0).toUpperCase() + titulo.slice(1).toLowerCase();

    const tbody = document.getElementById('tabla-body');
    tbody.innerHTML = `<tr><td colspan='10' style='text-align:center;color:#6b7280;'>Cargando datos...</td></tr>`;

    let data = [], error = null;
    if (tipo.toUpperCase() === 'ADULTOS') {
      // Buscar las denominaciones agrupadas para ADULTOS
      const res = await supabaseClient
        .from('establecimientos')
        .select('*')
        .in('denominacion', [
          'COLEGIO PARA ADULTOS',
          'ESCUELA PARA ADULTOS',
          'ESCUELA DE COMERCIO',
          'CENTRO EDUCATIVO NIVEL SECUNDARIO'
        ]);
      data = res.data || [];
      error = res.error;
    } else {
      const res = await supabaseClient
        .from('establecimientos')
        .select('*')
        .eq('denominacion', tipo.toUpperCase());
      data = res.data || [];
      error = res.error;
    }
    if (error) {
      tbody.innerHTML = `<tr><td colspan='11' style='color:red;text-align:center;'>Error al cargar los datos</td></tr>`;
      console.error(error);
      return;
    }
    datosActuales = data;
    filtrarYMostrar();
    // Llenar filtros de categoría y región y limpiar selección
    setTimeout(()=>{
      const selectCat = document.getElementById('filtro-categoria-listado');
      const selectReg = document.getElementById('filtro-region-listado');
      if (selectCat && selectReg) {
  // Categoría
  const categorias = [...new Set((data||[]).map(e=>e.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  selectCat.innerHTML = '<option value="">Todas</option>' + categorias.map(cat=>`<option value="${cat}">${cat}</option>`).join('');
  selectCat.value = '';
  // Región
  const regiones = [...new Set((data||[]).map(e=>e.region).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  selectReg.innerHTML = '<option value="">Todas</option>' + regiones.map(reg=>`<option value="${reg}">${reg}</option>`).join('');
  selectReg.value = '';
        selectCat.onchange = filtrarYMostrar;
        selectReg.onchange = filtrarYMostrar;
      }
    }, 0);
  }

    // Filtros eliminados
// actualizarContadores eliminado: ya no hay contador en la interfaz
    function filtrarYMostrar() {
      const tbody = document.getElementById('tabla-body');
      let filtrados = datosActuales;
      // Filtro por texto del buscador
      const buscadorListado = document.getElementById('buscador-listado');
      const texto = buscadorListado ? buscadorListado.value.trim().toLowerCase() : '';
      if (texto) {
        filtrados = filtrados.filter(e =>
          (e.categoria && e.categoria.toLowerCase().includes(texto)) ||
          (e.region && e.region.toLowerCase().includes(texto)) ||
          (e.denominacion && e.denominacion.toLowerCase().includes(texto)) ||
          (e.nro && String(e.nro).toLowerCase().includes(texto)) ||
          (e.nombre && e.nombre.toLowerCase().includes(texto))
        );
      }
      // Filtros de categoría y región
      const selectCat = document.getElementById('filtro-categoria-listado');
      const selectReg = document.getElementById('filtro-region-listado');
      if (selectCat && selectCat.value) {
        filtrados = filtrados.filter(e => e.categoria === selectCat.value);
      }
      if (selectReg && selectReg.value) {
        filtrados = filtrados.filter(e => e.region === selectReg.value);
      }
      // Ordenar por nro de menor a mayor (numérico)
      filtrados = [...filtrados].sort((a, b) => {
        if (a.nro == null && b.nro == null) return 0;
        if (a.nro == null) return 1;
        if (b.nro == null) return -1;
        const na = isNaN(Number(a.nro)) ? a.nro : Number(a.nro);
        const nb = isNaN(Number(b.nro)) ? b.nro : Number(b.nro);
        if (typeof na === 'number' && typeof nb === 'number') return na - nb;
        return String(na).localeCompare(String(nb), 'es', {numeric:true});
      });
      if (!filtrados || filtrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan='5' style='text-align:center;color:#6b7280;'>No se encontraron registros para ${tipoActual}</td></tr>`;
        return;
      }
    // Mantener la última lista filtrada para exportaciones
  window.lastFiltrados = filtrados;
  // Resumen arriba de la tabla (solo en el div externo)
  // Resumen visual eliminado (deshacer cambio)
  // Actualizar el total en el label
  const totalLabel = document.getElementById('total-listado');
  if (totalLabel) totalLabel.textContent = filtrados.length;
  tbody.innerHTML = filtrados.map((item, idx) => `
        <tr class="fila-establecimiento" data-idx="${idx}" style="cursor:pointer;transition:background 0.18s;">
          <td style="color:#1B2A41;font-size:1.04em;border:none;text-align:center;">${item.categoria || ''}</td>
          <td style="color:#1B2A41;font-size:1.04em;border:none;text-align:center;">${item.region || ''}</td>
          <td style="color:#1B2A41;font-size:1.04em;border:none;text-align:center;">${item.denominacion || ''}</td>
          <td style="color:#1B2A41;font-size:1.04em;border:none;text-align:center;">${item.nro || ''}</td>
          <td style="color:#1B2A41;font-size:1.04em;border:none;text-align:center;">${item.nombre || ''}</td>
        </tr>`).join('');
      // Efecto hover moderno azul-celeste
      document.querySelectorAll('.fila-establecimiento').forEach(row => {
        row.addEventListener('mouseenter', function() {
          this.style.background = '#56B4C6';
        });
        row.addEventListener('mouseleave', function() {
          this.style.background = '';
        });
        row.addEventListener('click', function() {
          const idx = this.getAttribute('data-idx');
          abrirModalDetalle(filtrados[idx]);
        });
      });
  // Actualizar estado de botones de exportación
  if (typeof updateExportButtons === 'function') updateExportButtons();
    }

    // Exportar listado a PDF completo usando jsPDF + autoTable, con logo
    async function exportListadoPDF() {
      const data = window.lastFiltrados || [];
      if (!data || data.length === 0) { alert('No hay datos para exportar'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');

      // Determinar columnas: usar keys encontradas en el primer objeto (ordenadas)
      const allKeys = Array.from(new Set(data.flatMap(d => Object.keys(d))));
      // Priorizar un orden legible si existen estas keys
      const preferredOrder = ['categoria','region','denominacion','nro','nombre','localidad','departamento','ambito','modalidad','niveles','url_matricula','url_pof','id'];
      allKeys.sort((a,b)=>{
        const ia = preferredOrder.indexOf(a) === -1 ? Number.MAX_SAFE_INTEGER : preferredOrder.indexOf(a);
        const ib = preferredOrder.indexOf(b) === -1 ? Number.MAX_SAFE_INTEGER : preferredOrder.indexOf(b);
        if (ia !== ib) return ia - ib;
        return a.localeCompare(b,'es',{sensitivity:'base'});
      });

      const headers = allKeys.map(k => k.charAt(0).toUpperCase() + k.slice(1));
      const body = data.map(r => allKeys.map(k => (r[k]===null||typeof r[k]==='undefined') ? '' : String(r[k])));

      // Cargar logo local y convertir a dataURL (fetch->blob preferido para evitar tainted canvas)
      async function loadImageDataUrl(src) {
        try {
          // Intentar fetch + blob
          const res = await fetch(src);
          if (res.ok) {
            const blob = await res.blob();
            return await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = () => resolve(null);
              reader.readAsDataURL(blob);
            });
          }
        } catch (e) {
          // seguir a fallback
        }
        // Fallback: Image -> canvas (puede taintearse si CORS bloquea)
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = function() {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img,0,0);
              resolve(canvas.toDataURL('image/png'));
            } catch (err) { resolve(null); }
          };
          img.onerror = function(){ resolve(null); };
          img.src = src;
        });
      }

      const logoData = await loadImageDataUrl('LOGO NUEVO COLOR_122003.png');

      // Agregar título y logo
      doc.setFontSize(14);
      if (logoData) {
        // Ajustar tamaño del logo y colocarlo a la izquierda
        const imgProps = doc.getImageProperties(logoData);
        const imgW = 36; // mm
        const imgH = (imgProps.height / imgProps.width) * imgW;
        doc.addImage(logoData, 'PNG', 14, 8, imgW, imgH);
        doc.text('Listado de establecimientos', 14 + imgW + 6, 16);
      } else {
        doc.text('Listado de establecimientos', 14, 16);
      }

      // Generar tabla con autoTable
      doc.autoTable({ startY: 28, head: [headers], body: body, styles: { fontSize: 9, cellPadding: 3 }, headStyles: { fillColor: [27,42,65], textColor: 255 } });
      doc.save('listado-establecimientos.pdf');
    }

    // Exportar listado a Excel (XLSX) usando SheetJS (xlsx)
    function exportListadoExcel() {
      const data = window.lastFiltrados || [];
      if (!data || data.length === 0) { alert('No hay datos para exportar'); return; }
      const ws_data = [ ['Categoría','Región','Denominación','N°','Nombre'] ];
      data.forEach(r => ws_data.push([r.categoria||'', r.region||'', r.denominacion||'', r.nro||'', r.nombre||'']));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'Listado');
      XLSX.writeFile(wb, 'listado-establecimientos.xlsx');
    }

    function updateExportButtons(){
      const pdfBtn = document.getElementById('btn-export-pdf');
      const xlsxBtn = document.getElementById('btn-export-xlsx');
      const has = (window.lastFiltrados && window.lastFiltrados.length>0);
      if (pdfBtn) pdfBtn.disabled = !has;
      if (xlsxBtn) xlsxBtn.disabled = !has;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      updateExportButtons();
    });

    function cargarCategorias() {
      const select = document.getElementById('filtro-categoria');
      const categorias = [...new Set(datosActuales.map(item => item.categoria).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'es', {sensitivity:'base'}));
      select.innerHTML = '<option value="">Todas las categorías</option>' + categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      select.onchange = filtrarYMostrar;
    }

  // Filtros eliminados: no se agregan listeners

    function volverInicio() {
  document.getElementById('pregunta-buscador').style.display = 'flex';
  document.getElementById('listado').style.display = 'none';
  // Pregunta y buscador eliminados, no se muestra nada
      const inicio = document.getElementById('inicio');
      inicio.style.display = 'grid';
      triggerGridAnimation();
    }

    async function buscarElemento() {
      // Si la interfaz de listado está visible, filtrar filas de la tabla
      const listado = document.getElementById('listado');
      const filtro = document.getElementById('buscador').value.toLowerCase();
      if (listado && listado.style.display !== 'none') {
        const tbody = document.getElementById('tabla-body');
        if (tbody) {
          const filas = tbody.querySelectorAll('tr.fila-establecimiento');
          filas.forEach(fila => {
            const nombre = (fila.querySelector('td:nth-child(5)')?.textContent || '').toLowerCase();
            if (filtro.length === 0 || nombre.includes(filtro)) {
              fila.style.display = '';
              fila.style.outline = filtro.length > 0 ? '2px solid #56B4C6' : '';
            } else {
              fila.style.display = 'none';
              fila.style.outline = '';
            }
          });
        }
      }
      const carpetas = document.querySelectorAll('.carpeta');
      // Limpiar nombres previos
      carpetas.forEach(carpeta => {
        carpeta.style.display = 'none';
        carpeta.style.outline = '';
        // Eliminar nombres previos
        let nombrePreview = carpeta.querySelector('.buscador-nombre-preview');
        if (nombrePreview) nombrePreview.remove();
      });

      if (filtro.length > 0) {
        const { data, error } = await supabaseClient
          .from('establecimientos')
          .select('nombre, denominacion')
          .ilike('nombre', `%${filtro}%`);
        if (!error && data && data.length > 0) {
          // Agrupar por denominación
          const agrupado = {};
          data.forEach(est => {
            const denom = est.denominacion || 'Sin carpeta';
            if (!agrupado[denom]) agrupado[denom] = [];
            agrupado[denom].push(est);
          });
          // Mostrar carpetas solo si hay coincidencia en el nombre de la escuela (columna nombre)
          carpetas.forEach(carpeta => {
            const denom = carpeta.getAttribute('data-denominacion') || '';
            if (agrupado[denom]) {
              carpeta.style.display = 'block';
              carpeta.style.outline = '3px solid #56B4C6';
              // Mostrar los nombres coincidentes debajo del nombre de la carpeta
              let h3 = carpeta.querySelector('h3');
              if (h3) {
                let preview = document.createElement('div');
                preview.className = 'buscador-nombre-preview';
                preview.style = 'margin-top:0.7em;font-size:1em;color:#fff;background:#56B4C6;border-radius:8px;padding:0.4em 0.7em;max-height:90px;overflow-y:auto;';
                preview.innerHTML = agrupado[denom].map(e => `<div style='white-space:normal;'>${e.nombre}</div>`).join('');
                h3.insertAdjacentElement('afterend', preview);
              }
            }
          });
        }
      }
    }

    function triggerGridAnimation() {
      const cards = document.querySelectorAll('.carpeta');
      cards.forEach((card, i) => {
        card.classList.remove('enter');
        card.style.animation = 'none';
        void card.offsetWidth;
        card.style.removeProperty('animation');
        card.style.setProperty('--delay', (i * 90) + 'ms');
        card.classList.add('enter');
      });
    }

    document.addEventListener('DOMContentLoaded', triggerGridAnimation);

  // Botón cerrar listado: ya se maneja con onclick="mostrarVistaPrincipal()" en el HTML
  </script>

  <footer style="width:100%;margin-top:2.5em;padding:1.2em 0 1.2em 0;background:var(--celeste,#56B4C6);color:#fff;text-align:center;font-size:1.08em;letter-spacing:0.5px;">
    © 2025 Dirección Gestión Educativa. Ministerio de Educación de la Provincia de San Luis.
  </footer>

  <script>
    function mostrarVistaPrincipal() {
  const inicio = document.getElementById('inicio');
  if (inicio) inicio.style.display = '';
  const subtitulo = document.getElementById('subtitulo');
  if (subtitulo) subtitulo.style.display = '';
  const contadores = document.getElementById('contadores-buscador-panel');
  if (contadores) contadores.style.display = '';
  const buscadorBar = document.getElementById('buscador-bar');
  if (buscadorBar) buscadorBar.style.display = '';
  const listado = document.getElementById('listado');
  if (listado) listado.style.display = 'none';
}
  </script>
  <!-- Librerías para exportar -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</body>
</html>
